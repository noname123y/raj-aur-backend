  import { ApiError } from "../utils/apiError.js";
import { User } from "../models/user.models.js";
import { uploadCloudinary } from "../utils/cloudinary.js";  
import { ApiResponse } from "../utils/apiResponse.js";
import jwt from "jsonwebtoken"
import { asyncHandler } from "../utils/asyncHandler.js"; 

// a method tyo create access and refresh token

const generateAccessAndRefereshTokens = async(userId) =>{
  try {
      const user = await User.findById(userId)
      const accessToken = user.generateAccessToken()
     
      const refreshToken = user.generateRefreshToken()

      user.refreshToken = refreshToken
      await user.save({ validateBeforeSave: false })

      return {accessToken, refreshToken}


  } catch (error) {
    
      throw new ApiError(500, "Something went wrong while generating referesh and access token")
  }
}


const registerUser= asyncHandler(async(req,res)=>{
 // get user dsetails
 // validation- not empty
 // check if user alredy exist-email or username
 // check for image,avatar
 //upload them on cloudinary,avatar
 // create user object-create entry in db
 // remove password and refresh token feild from response
 // check for user creation
 // return response


 const{fullname,email,username,password}=req.body
 

 if([fullname,email,username,password].some((feild)=>(
  feild.trim()===""
 ))){
  throw new ApiError(400,"all feild is required")
 }
 // validating the user
const existeduser=await User.findOne({
  $or:[{ username },{ email }]
})



if(existeduser){
  throw new ApiError(409,"User already exist")
}
//extracting the local path of avatar and coverImage
const avavtarLocalPath=req.files?.avatar[0]?.path


let CoverImageLocalPath;
if(req.files && Array.isArray(req.files.coverImage)  && req.files.coverImage.length>0){
  CoverImageLocalPath=req.files.coverImage[0].path;
}
console.log(req.files)
if(!avavtarLocalPath){
  throw new ApiError(400,"Avatar file is required")
};
//upload on cloudinary
const avatar=await uploadCloudinary(avavtarLocalPath);
const coverImage=await uploadCloudinary(CoverImageLocalPath)

//check if avatar is uploaded or not
if(!avatar){
  throw new ApiError(400,"Avatar is not loaded")
}

//entery into database
const user=await User.create({
fullname,
avatar:avatar.url,
coverImage:coverImage?.url|| "",
email,
password,
username:username.toLowerCase()


})

const createdUser= await User.findById(user._id).select(
  "-password -refreshToken"
)
if(!createdUser){
  throw new ApiError(500,"something went wrong while registring the user")
}

return res.status(201).json(
  new ApiResponse(200,createdUser,"User registered sucessfully")

)


})

const loginUser=asyncHandler(async(req,res)=>{
  // get the data from req body
  // username or email
  //find the user
  //password check
  // acess and refresh token
  // send cookie

  const{email,username,password}=req.body

  if(!(username || email)){
    throw new ApiError(404,"username or email is required")
  }

  const user=await User.findOne({
    $or:[{username},{email}]
  })

  if(!user){
    throw new ApiError(404,"user do not exist")
  }
     
  const ispasswordvalid= await user.isPasswordCorrect(password)

     if(!ispasswordvalid){
      throw new ApiError(401,"user password do not match")
    }

   const {accessToken,refreshToken}=await generateAccessAndRefereshTokens(user._id)

   const loggedInUser= await User.findById(user._id).
   select("-password -refreshToken")

   //cookies setup
   // only modifiablle by server side using options 
   const options={
    httpOnly:true,
    secure:true
   }
    return res
    .status(200)
    .cookie("accessToken",accessToken,options)
    .cookie("refreshToken",refreshToken,options)
    .json(
      new ApiResponse(
          200, 
          {
              user: loggedInUser ,accessToken, refreshToken
          },
          "User logged In Successfully"
      )
  )
  })

 const logOutuser=asyncHandler(async(req,res)=>{
  console.log(req.user)
  await User.findByIdAndUpdate(
    req.user._id,{
      $unset:{
        refreshToken:1
      }
    },{
      new:true
    }
   )

   const options={
    httpOnly:true,
    secure:true
   }

   return res
   .status(200)
   
   .clearCookie("accessToken",options)
   .clearCookie("refreshToken",options)
   .json(new ApiResponse(200,{},"User logged out sucessfully"))
 }) 

 const refreshaccessToken= asyncHandler(async(req,res)=>{
       const incomingrefreshToken=req.cookies.refreshToken|| req.body

       if(!incomingrefreshToken){
        throw new ApiError(404,"Unauthorized request")
       }

       try {
        const decodedToken=jwt.verify(refreshToken,process.env.REFRESH_TOKEN_SECRET)
        
        const user=await User.findById(decodedToken._id)
         
        if(!user){
         throw new ApiError(401,"Invalid refresh token")
        }
 
        if(incomingrefreshToken!==user?.refreshToken){
         throw new ApiError(401,"refresh token is invalid or used")
        }
 
         const options={
           httpOnly:true,
           secure:true}
 
        const {accessToken,refreshToken}=await generateAccessAndRefereshTokens(user._id)
        
        return res.status(200)
        .cookie("accessToken",accessToken,options)
       .cookie("refreshToken",refreshToken,options)
       .json(  new ApiResponse(
         200,
         {accessToken,refreshToken},
         "access token refreshed"
 
       ))  
       } catch (error) {

        throw new ApiError(401,error?.message|| "Invalid refresh token")

        
       }
    })

const changeCurrentPassword=asyncHandler(async(req,res)=>{
  const{oldPassword,newPassword}=req.body

  if(oldPassword && newPassword ){
    throw new ApiError(401,"Invalid request")
  }

  const user=await User.findById(req.user._id)

 const isPasswordCorrect= await user.isPasswordCorrect(oldPassword)
 // or 
 // if(user.password!==oldPassword){
  //   throw new ApiError(401,"password not matching")
  // }

if(!isPasswordCorrect){
  throw new ApiError(400,"Invalid old passowrd")
}

user.password=newPassword
await user.save({validateBeforeSave})

// or
  // await User.findByIdAndUpdate(
  //   req.user._id,{
  //     $set:{
  //       passowrd:newPassword
  //     }
  //   },{
  //     new:true
  //   }
  //  )

  return res
  .status(200)
  .json(new ApiResponse(200,{},"Passowrd changed sucessfully"))
})

const getCurrentuser=asyncHandler(async(req,res)=>{
  const user=await User.findById(req.user._id)
return res.status(200)
.json( new ApiResponse(200,user,"Current user fetched dsuccessfully"))
})

const Updateuserdetails = asyncHandler(async(req,res)=>{
  const {fullname,email}=req.body

  if(!fullname || !email){
    throw new ApiError(400,"All feilds Are required")
  }
   
 const user= await User.findByIdAndUpdate(
    req.user?._id,{
      $set:{
        fullname:fullname,
        email:email
      }
    },{
      new:true
    }
  ).select("-password")
  return res
  .status(200)
  .json(new ApiResponse(200,user,"Account details updated sucessfully"))
  
})

const UpdateAvatar=asyncHandler(async(req,res)=>{
 const avatarlocalPath= req.file?.path

 if(!avatarlocalPath){
  throw ApiError(400,"Avatar file is missing")
 }

const avatar= await uploadCloudinary(avatarlocalPath)
if(!avatar.url){
  throw new ApiError(400,"Error while uploading")
}

const user=await User.findByIdAndUpdate(req.user._id,{
  $set:{
    avatar:avatar.url
  }
},{
  new:true
}).select("-password")

return res.status(200)
.json(new ApiResponse(200,user,"avatar updated sucessfully"))

})

const getuserProfile=asyncHandler(async(req,res)=>{

  const username=req.params

  if(!username){
    throw new ApiError(400,"username not found")

  }

 const user=await User.aggregate([
  {
    $match:{
      username:username
    }
  },
    {
      $lookup:{
        from:"subscriptions",
        localField:_id,
        foreignField:"channel",
        as:"Subscribers"


      }
    },
    {
      $lookup:{
        from:"subscriptions",
        localField:_id,
        foreignField:"subscriber",
        as:"SubscribedTo"
        }
    },
    {
      $addFields:{
        subscribersCount:{
          $size:"$Subscribers"
        },

        channelSubscribedTocount:{
          $size:"$SubscribedTo"
           
        },

        isSubscribed:{
          $cond:{
            if:{$in:[req.user?._id,"$Subscribers.subscriber"]},
            then:true,
            else:false
          }
        }

      }
    },
    {
      $project:{
        fullname:1,
        username:1,
        subscribersCount:1,
        channelSubscribedTocount:1,
        isSubscribed:1,
        avatar:1,
        coverImage:1,
        email:1

      }
    }

  ])
  // aggrete pipeline returns an array

  if(!user?.length){
    throw new ApiError(400," user profile  not created")
  }
  return res
  .status(200)
  .json(new ApiResponse(200,user[0],"user profile created sucessfully"))



})

export {registerUser,loginUser,logOutuser,refreshaccessToken,changeCurrentPassword,getCurrentuser,Updateuserdetails,UpdateAvatar}










































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































